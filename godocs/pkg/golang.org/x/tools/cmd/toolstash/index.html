<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#375EAB">

  <title>toolstash - The Go Programming Language</title>

<link type="text/css" rel="stylesheet" href="../../../../../../lib/godoc/style.css">

<link rel="stylesheet" href="../../../../../../lib/godoc/jquery.treeview.css">
<script type="text/javascript">window.initFuncs = [];</script>
</head>
<body>

<div id='lowframe' style="position: fixed; bottom: 0; left: 0; height: 0; width: 100%; border-top: thin solid grey; background-color: white; overflow: auto;">
...
</div><!-- #lowframe -->

<div id="topbar" class="wide"><div class="container">
<div class="top-heading" id="heading-wide"><a href="http://localhost:8081/">The Go Programming Language</a></div>
<div class="top-heading" id="heading-narrow"><a href="http://localhost:8081/">Go</a></div>
<a href="index.html#" id="menu-button"><span id="menu-button-arrow">&#9661;</span></a>
<form method="GET" action="http://localhost:8081/search">
<div id="menu">
<a href="http://localhost:8081/doc/">Documents</a>
<a href="../../../../../index.html">Packages</a>
<a href="http://localhost:8081/project/">The Project</a>
<a href="http://localhost:8081/help/">Help</a>

<a href="http://localhost:8081/blog/">Blog</a>


<span class="search-box"><input type="search" id="search" name="q" placeholder="Search" aria-label="Search" required><button type="submit"><span><!-- magnifying glass: --><svg width="24" height="24" viewBox="0 0 24 24"><title>submit search</title><path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/><path d="M0 0h24v24H0z" fill="none"/></svg></span></button></span>
</div>
</form>

</div></div>



<div id="page" class="wide">
<div class="container">


  <h1>
    Command toolstash
    <span class="text-muted"></span>
  </h1>







<div id="nav"></div>


<!--
	Copyright 2009 The Go Authors. All rights reserved.
	Use of this source code is governed by a BSD-style
	license that can be found in the LICENSE file.
-->
<!--
	Note: Static (i.e., not template-generated) href and id
	attributes start with "pkg-" to make it impossible for
	them to conflict with generated attributes (some of which
	correspond to Go identifiers).
-->

	<script type='text/javascript'>
	document.ANALYSIS_DATA = null;
	document.CALLGRAPH = null;
	</script>

	
		
		<p>
Toolstash provides a way to save, run, and restore a known good copy of the Go toolchain
and to compare the object files generated by two toolchains.
</p>
<p>
Usage:
</p>
<pre>toolstash [-n] [-v] save [tool...]
toolstash [-n] [-v] restore [tool...]
toolstash [-n] [-v] [-t] go run x.go
toolstash [-n] [-v] [-t] [-cmp] compile x.go
</pre>
<p>
The toolstash command manages a &ldquo;stashed&rdquo; copy of the Go toolchain
kept in $GOROOT/pkg/toolstash. In this case, the toolchain means the
tools available with the &#39;go tool&#39; command as well as the go, godoc, and gofmt
binaries.
</p>
<p>
The command &ldquo;toolstash save&rdquo;, typically run when the toolchain is known to be working,
copies the toolchain from its installed location to the toolstash directory.
Its inverse, &ldquo;toolchain restore&rdquo;, typically run when the toolchain is known to be broken,
copies the toolchain from the toolstash directory back to the installed locations.
If additional arguments are given, the save or restore applies only to the named tools.
Otherwise, it applies to all tools.
</p>
<p>
Otherwise, toolstash&#39;s arguments should be a command line beginning with the
name of a toolchain binary, which may be a short name like compile or a complete path
to an installed binary. Toolstash runs the command line using the stashed
copy of the binary instead of the installed one.
</p>
<p>
The -n flag causes toolstash to print the commands that would be executed
but not execute them. The combination -n -cmp shows the two commands
that would be compared and then exits successfully. A real -cmp run might
run additional commands for diagnosis of an output mismatch.
</p>
<p>
The -v flag causes toolstash to print the commands being executed.
</p>
<p>
The -t flag causes toolstash to print the time elapsed during while the
command ran.
</p>
<h3 id="hdr-Comparing">Comparing</h3>
<p>
The -cmp flag causes toolstash to run both the installed and the stashed
copy of an assembler or compiler and check that they produce identical
object files. If not, toolstash reports the mismatch and exits with a failure status.
As part of reporting the mismatch, toolstash reinvokes the command with
the -S flag and identifies the first divergence in the assembly output.
If the command is a Go compiler, toolstash also determines whether the
difference is triggered by optimization passes.
On failure, toolstash leaves additional information in files named
similarly to the default output file. If the compilation would normally
produce a file x.6, the output from the stashed tool is left in x.6.stash
and the debugging traces are left in x.6.log and x.6.stash.log.
</p>
<p>
The -cmp flag is a no-op when the command line is not invoking an
assembler or compiler.
</p>
<p>
For example, when working on code cleanup that should not affect
compiler output, toolstash can be used to compare the old and new
compiler output:
</p>
<pre>toolstash save
&lt;edit compiler sources&gt;
go tool dist install cmd/compile # install compiler only
toolstash -cmp compile x.go
</pre>
<h3 id="hdr-Go_Command_Integration">Go Command Integration</h3>
<p>
The go command accepts a -toolexec flag that specifies a program
to use to run the build tools.
</p>
<p>
To build with the stashed tools:
</p>
<pre>go build -toolexec toolstash x.go
</pre>
<p>
To build with the stashed go command and the stashed tools:
</p>
<pre>toolstash go build -toolexec toolstash x.go
</pre>
<p>
To verify that code cleanup in the compilers does not make any
changes to the objects being generated for the entire tree:
</p>
<pre># Build working tree and save tools.
./make.bash
toolstash save

&lt;edit compiler sources&gt;

# Install new tools, but do not rebuild the rest of tree,
# since the compilers might generate buggy code.
go tool dist install cmd/compile

# Check that new tools behave identically to saved tools.
go build -toolexec &#39;toolstash -cmp&#39; -a std

# If not, restore, in order to keep working on Go code.
toolstash restore
</pre>
<h3 id="hdr-Version_Skew">Version Skew</h3>
<p>
The Go tools write the current Go version to object files, and (outside
release branches) that version includes the hash and time stamp
of the most recent Git commit. Functionally equivalent
compilers built at different Git versions may produce object files that
differ only in the recorded version. Toolstash ignores version mismatches
when comparing object files, but the standard tools will refuse to compile
or link together packages with different object versions.
</p>
<p>
For the full build in the final example above to work, both the stashed
and the installed tools must use the same version string.
One way to ensure this is not to commit any of the changes being
tested, so that the Git HEAD hash is the same for both builds.
A more robust way to force the tools to have the same version string
is to write a $GOROOT/VERSION file, which overrides the Git-based version
computation:
</p>
<pre>echo devel &gt;$GOROOT/VERSION
</pre>
<p>
The version can be arbitrary text, but to pass all.bash&#39;s API check, it must
contain the substring &ldquo;devel&rdquo;. The VERSION file must be created before
building either version of the toolchain.
</p>

	

	







<div id="footer">
Build version go1.8.3.<br>
Except as <a href="https://developers.google.com/site-policies#restrictions">noted</a>,
the content of this page is licensed under the
Creative Commons Attribution 3.0 License,
and code is licensed under a <a href="http://localhost:8081/LICENSE">BSD license</a>.<br>
<a href="http://localhost:8081/doc/tos.html">Terms of Service</a> |
<a href="http://www.google.com/intl/en/policies/privacy/">Privacy Policy</a>
</div>

</div><!-- .container -->
</div><!-- #page -->

<!-- TODO(adonovan): load these from <head> using "defer" attribute? -->
<script type="text/javascript" src="../../../../../../lib/godoc/jquery.js"></script>
<script type="text/javascript" src="../../../../../../lib/godoc/jquery.treeview.js"></script>
<script type="text/javascript" src="../../../../../../lib/godoc/jquery.treeview.edit.js"></script>


<script>var goVersion = "go1.8.3";</script>
<script type="text/javascript" src="../../../../../../lib/godoc/godocs.js"></script>

</body>
</html>

